<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dynamic CSV Query App</title>
  <link rel="stylesheet" href="/static/styles.css">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6">

  <h1 class="text-3xl font-bold text-blue-700 mb-6">üìä Dynamic CSV Query App</h1>

  <!-- CSV Upload Section -->
  <div class="bg-white shadow-lg rounded-2xl p-6 w-full max-w-lg mb-6">
    <h2 class="text-xl font-semibold mb-4">Upload CSV</h2>
    <input type="file" id="csvFile" accept=".csv" class="mb-4">
    <button onclick="uploadCSV()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Upload</button>
    <p id="uploadMessage" class="mt-3 text-green-700 font-medium"></p>
    <p id="columns" class="mt-2 text-gray-600 text-sm"></p>
  </div>

  <!-- Query Section -->
  <div class="bg-white shadow-lg rounded-2xl p-6 w-full max-w-lg">
    <h2 class="text-xl font-semibold mb-4">Ask a Query</h2>
    <input type="text" id="queryInput" placeholder="e.g., show all details for City Hyderabad"
      class="w-full p-2 border rounded mb-4">
    <button onclick="runQuery()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Run Query</button>
    <div id="queryMessage" class="mt-3 text-red-600"></div>
  </div>

  <!-- Results Section -->
  <div class="mt-8 w-full max-w-4xl">
    <h2 class="text-2xl font-semibold mb-4">Results</h2>
    <div class="flex justify-between items-center mb-3">
      <p class="text-gray-600">Query Results:</p>
      <button id="downloadBtn" onclick="downloadCSV()" class="hidden bg-purple-600 text-white px-3 py-1 rounded hover:bg-purple-700">
        ‚¨áÔ∏è Download CSV
      </button>
    </div>
    <div id="resultsContainer" class="overflow-x-auto"></div>
  </div>

  <script>
    let currentFilename = "";
    let lastQueryResults = [];

    async function uploadCSV() {
      const fileInput = document.getElementById("csvFile");
      if (!fileInput.files.length) { alert("Select CSV first."); return; }
      const formData = new FormData();
      formData.append("file", fileInput.files[0]);
      const res = await fetch("/upload_csv", { method: "POST", body: formData });
      const data = await res.json();
      document.getElementById("uploadMessage").innerText = data.message;
      document.getElementById("columns").innerText = "Columns: " + data.columns.join(", ");
      currentFilename = fileInput.files[0].name;
    }

    async function runQuery() {
      const query = document.getElementById("queryInput").value;
      if (!query || !currentFilename) { alert("Upload CSV and enter query first."); return; }
      const res = await fetch("/query_csv", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ filename: currentFilename, query: query })
      });
      const data = await res.json();
      if (data.error) { document.getElementById("queryMessage").innerText = data.error; return; }
      lastQueryResults = data;
      document.getElementById("downloadBtn").classList.remove("hidden");
      renderTable(data);
    }

    function renderTable(data) {
      if (!data.length) { document.getElementById("resultsContainer").innerHTML = "<p>No results found.</p>"; return; }
      let table = "<table class='table-auto border-collapse border border-gray-400 w-full'><thead><tr>";
      Object.keys(data[0]).forEach(col => { table += `<th class='border px-4 py-2 bg-gray-200'>${col}</th>`; });
      table += "</tr></thead><tbody>";
      data.forEach(row => {
        table += "<tr>";
        Object.values(row).forEach(val => { table += `<td class='border px-4 py-2'>${val}</td>`; });
        table += "</tr>";
      });
      table += "</tbody></table>";
      document.getElementById("resultsContainer").innerHTML = table;
    }

    function downloadCSV() {
      if (!lastQueryResults.length) { alert("No query results."); return; }
      const headers = Object.keys(lastQueryResults[0]).join(",");
      const rows = lastQueryResults.map(row => Object.values(row).map(val => `"${String(val).replace(/"/g, '""')}"`).join(","));
      const csvContent = [headers, ...rows].join("\n");
      const blob = new Blob([csvContent], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = "query_results.csv"; a.click();
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
